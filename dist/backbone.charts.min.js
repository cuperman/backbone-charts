/*! backbone.charts 20-01-2014 */
Backbone.Charts=Backbone.Charts||{},Backbone.Charts.Chart=Backbone.View.extend({baseOptions:{data:[],x:function(a,b){return b},y:function(a){return a},width:400,height:200,paddingLeft:0,paddingRight:0,paddingTop:0,paddingBottom:0,scaleTypeX:"linear",scaleTypeY:"linear",tickCountX:null,tickCountY:null,tickFormatX:null,tickFormatY:null,gridTickCount:4},options:{},initialize:function(a){_.chain({}).extend(this.baseOptions,this.options,a).pick(_.union(Object.keys(this.baseOptions),Object.keys(this.options))).each(function(a,b){this[b]=a},this),this.setScales(),this.setAxes()},chartWidth:function(){return this.width-this.paddingLeft-this.paddingRight},chartHeight:function(){return this.height-this.paddingTop-this.paddingBottom},minX:function(){return d3.min(this.data,this.x)},minY:function(){return d3.min(this.data,this.y)},maxX:function(){return d3.max(this.data,this.x)},maxY:function(){return d3.max(this.data,this.y)},chartLeft:function(){return this.paddingLeft},chartRight:function(){return this.paddingLeft+this.chartWidth()},chartTop:function(){return this.paddingTop},chartBottom:function(){return this.paddingTop+this.chartHeight()},scaleXOrdinalPoints:function(){return d3.scale.ordinal().domain(this.data.map(this.x)).rangePoints([this.chartLeft(),this.chartRight()])},scaleXOrdinalBands:function(){return d3.scale.ordinal().domain(this.data.map(this.x)).rangeRoundBands([this.chartLeft(),this.chartRight()],this.columnPadding,this.columnOuterPadding)},scaleXLinear:function(){return d3.scale.linear().domain([0,this.maxX()]).range([this.chartLeft(),this.chartRight()])},scaleXTime:function(){return d3.time.scale().domain([this.minX(),this.maxX()]).range([this.chartLeft(),this.chartRight()])},scaleYLinear:function(){return d3.scale.linear().domain([0,this.maxY()]).range([this.chartBottom(),this.chartTop()])},setScaleX:function(){switch(this.scaleTypeX){case"linear":this.scaleX=this.scaleXLinear();break;case"ordinalPoints":this.scaleX=this.scaleXOrdinalPoints();break;case"ordinalBands":this.scaleX=this.scaleXOrdinalBands();break;case"time":this.scaleX=this.scaleXTime()}return this},setScaleY:function(){switch(this.scaleTypeY){case"linear":this.scaleY=this.scaleYLinear()}return this},setScales:function(){return this.setScaleX(),this.setScaleY(),this},setAxisX:function(){return this.axisX=d3.svg.axis().scale(this.scaleX).orient("bottom"),this.tickCountX&&this.axisX.ticks(this.tickCountX),this.tickFormatX&&this.axisX.tickFormat(this.tickFormatX),this},setAxisY:function(){return this.axisY=d3.svg.axis().scale(this.scaleY).orient("left"),this.tickCountY&&this.axisY.ticks(this.tickCountY),this.tickFormatY&&this.axisY.tickFormat(this.tickFormatY),this},setAxes:function(){return this.setAxisX(),this.setAxisY(),this},invertX:function(a){if(this.scaleTypeX.match(/^ordinal.*/)){var b=a-this.chartLeft(),c=b/this.chartWidth();return c*this.data.length}return this.scaleX.invert(a)},findClosestDatum:function(a){return _.find(this.data,function(b){return a<this.x(b)},this)},renderSvg:function(){return this.svg=d3.select(this.el).append("svg").attr("width",this.width).attr("height",this.height),this.bindSvgListeners(),this},renderAxisX:function(){return this.svg.append("g").attr("class","axis axis-x").attr("transform","translate(0,"+this.chartBottom()+")").call(this.axisX),this},renderAxisY:function(){return this.svg.append("g").attr("class","axis axis-y").attr("transform","translate("+this.chartLeft()+",0)").call(this.axisY),this},renderGridHorizontal:function(){var a=this.scaleY.ticks(this.gridTickCount),b=d3.scale.linear().domain([d3.min(a),d3.max(a)]).range([this.chartTop(),this.chartBottom()]);return this.svg.selectAll("line.grid").data(this.scaleY.ticks(this.gridTickCount)).enter().append("line").attr("class","grid").attr("x1",this.chartLeft()).attr("x2",this.chartRight()).attr("y1",function(a){return b(a)}).attr("y2",function(a){return b(a)}),this},render:function(){return this},bindSvgListeners:function(){var a=this;this.svg&&(this.svg.on("mouseover",function(){var b=d3.mouse(this),c={x:b[0],y:b[1]};a.trigger("svg:mouse:over",c)}),this.svg.on("mousemove",function(){var b=d3.mouse(this),c={x:b[0],y:b[1]};a.trigger("svg:mouse:move",c)}),this.svg.on("mouseout",function(){var b=d3.mouse(this),c={x:b[0],y:b[1]};a.trigger("svg:mouse:out",c)}))}}),Backbone.Charts=Backbone.Charts||{},Backbone.Charts.ArcChart=Backbone.View.extend({baseOptions:{data:[],value:function(a){return a},width:400,height:200,radius:100,innerRadius:0},options:{},initialize:function(a){_.chain({}).extend(this.baseOptions,this.options,a).pick(_.union(Object.keys(this.baseOptions),Object.keys(this.options))).each(function(a,b){this[b]=a},this),this.setLayout(),this.setArc()},setLayout:function(){this.layout=d3.layout.pie().value(this.value)},setArc:function(){this.arc=d3.svg.arc().outerRadius(this.radius).innerRadius(this.innerRadius)},render:function(){return this}}),Backbone.Charts=Backbone.Charts||{},Backbone.Charts.BarChart=Backbone.Charts.Chart.extend({options:{scaleTypeX:"ordinalBands",scaleTypeY:"linear",columnPadding:.1,columnOuterPadding:0,showAxisX:!1,showAxisY:!1,showGridHorizontal:!1},render:function(){var a=this;return this.renderSvg(),this.showGridHorizontal&&this.renderGridHorizontal(),this.svg.selectAll("rect").data(this.data).enter().append("rect").attr("x",function(b,c){return a.scaleX(a.x(b,c))}).attr("y",function(b,c){return a.scaleY(a.y(b,c))}).attr("width",a.scaleX.rangeBand()).attr("height",function(b,c){return a.paddingTop+a.chartHeight()-a.scaleY(a.y(b,c))}),this.showAxisX&&this.renderAxisX(),this.showAxisY&&this.renderAxisY(),this}}),Backbone.Charts=Backbone.Charts||{},Backbone.Charts.LineChart=Backbone.Charts.Chart.extend({options:{scaleTypeX:"ordinalPoints",scaleTypeY:"linear",showAxisX:!1,showAxisY:!1,showGridHorizontal:!1,showMarker:!1,markerFormat:function(a,b){return"x: "+a.toString()+", y: "+b.toString()}},initialize:function(){Backbone.Charts.Chart.prototype.initialize.apply(this,arguments),this.showMarker&&(this.listenTo(this,"svg:mouse:over",this.markerShow),this.listenTo(this,"svg:mouse:move",this.markerMove),this.listenTo(this,"svg:mouse:out",this.markerHide))},renderMarker:function(){return this.marker=this.svg.append("circle").attr("cx",0).attr("cy",0).attr("r",3).attr("class","marker").style("display","none"),this.markerText=this.svg.append("text").attr("y",0).attr("dy","1em").attr("text-anchor","end").attr("class","marker-text").style("display","none"),this},render:function(){var a=this;this.renderSvg(),this.showGridHorizontal&&this.renderGridHorizontal();var b=d3.svg.line().x(function(b,c){return a.scaleX(a.x(b,c))}).y(function(b,c){return a.scaleY(a.y(b,c))});return this.svg.append("path").datum(this.data).attr("d",b).attr("class","line"),this.showAxisX&&this.renderAxisX(),this.showAxisY&&this.renderAxisY(),this.showMarker&&this.renderMarker(),this},markerShow:function(){return this.marker&&this.marker.style("display","block"),this.markerText&&this.markerText.style("display","block"),!1},markerHide:function(){return this.marker&&this.marker.style("display","none"),this.markerText&&this.markerText.style("display","none"),!1},markerMove:function(a){var b=this.scaleX(Math.round(this.invertX(a.x))),c=this.findClosestDatum(this.invertX(b)),d=this.x(c),e=this.y(c);return d&&e&&this.marker&&(this.marker.attr("cx",this.scaleX(d)),this.marker.attr("cy",this.scaleY(e))),d&&e&&this.markerText&&this.markerText.text(this.markerFormat(d,e)),!1}}),Backbone.Charts=Backbone.Charts||{},Backbone.Charts.MultiLineChart=Backbone.Charts.Chart.extend({options:{y:[],scaleTypeX:"ordinalPoints",scaleTypeY:"linear",showAxisX:!1,showAxisY:!1,showGridHorizontal:!1},minY:function(){return d3.min(this.data,function(a){return d3.min(_.map(this.y,function(b){return b(a)}))})},maxY:function(){var a=this;return d3.max(this.data,function(b){return d3.max(_.map(a.y,function(a){return a(b)}))})},render:function(){return this.renderSvg(),this.showGridHorizontal&&this.renderGridHorizontal(),_.each(this.y,function(a,b){var c=this,d=b+1,e=d3.svg.line().x(function(a,b){return c.scaleX(c.x(a,b))}).y(function(b,d){return c.scaleY(a(b,d))});this.svg.append("path").datum(this.data).attr("d",e).attr("class","line line-y"+d)},this),this.showAxisX&&this.renderAxisX(),this.showAxisY&&this.renderAxisY(),this}}),Backbone.Charts=Backbone.Charts||{},Backbone.Charts.PieChart=Backbone.Charts.ArcChart.extend({render:function(){var a=d3.select(this.el).append("svg").attr("width",this.width).attr("height",this.height),b=a.selectAll("g.arc").data(this.layout(this.data)).enter().append("g").attr("class","arc").attr("transform","translate("+this.radius+", "+this.radius+")");return b.append("path").attr("d",this.arc),this}}),Backbone.Charts=Backbone.Charts||{},Backbone.Charts.RingChart=Backbone.Charts.ArcChart.extend({options:{innerRadius:50},render:function(){var a=d3.select(this.el).append("svg").attr("width",this.width).attr("height",this.height),b=a.selectAll("g.arc").data(this.layout(this.data)).enter().append("g").attr("class","arc").attr("transform","translate("+this.radius+", "+this.radius+")");return b.append("path").attr("d",this.arc),this}});